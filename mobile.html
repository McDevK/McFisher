<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>McFisher - 移动端</title>
  <link rel="icon" href="./assets/icons/others/profile.webp" type="image/webp">
  <link rel="stylesheet" href="./mobile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-fish"></i>
        <span>McFisher</span>
      </div>
      <div class="header-right">
        <div class="local-time-box">
          <div class="time-row">
            <span class="time-label">艾</span>
            <span class="time-value" id="eorzeaTimeValue">00:00</span>
          </div>
          <div class="time-row">
            <span class="time-label">本</span>
            <span class="time-value" id="localTimeValue">00:00</span>
          </div>
        </div>
        <button class="theme-toggle" id="themeToggle" title="切换主题" aria-label="切换主题"><i class="fas fa-moon"></i></button>
        <button class="settings-toggle" id="settingsToggle" title="设置" aria-label="设置"><img src="./assets/icons/button/setting.png" alt="设置" onerror="this.style.display='none'" /></button>
        <input id="importDataInput" type="file" accept="application/json" hidden />
      </div>
    </div>
  </header>

  <main class="main-content">
    
    <!-- 头像裁剪浮窗 -->
    <div id="avatarModal" class="avatar-modal hidden" role="dialog" aria-modal="true" aria-labelledby="avatarModalTitle">
      <div class="avatar-modal-content">
        <div class="avatar-modal-header">
          <h3 id="avatarModalTitle">调整头像</h3>
        </div>
        <div class="avatar-modal-body">
          <div class="avatar-modal-canvas-wrap">
            <canvas id="avatarCanvas" width="420" height="300"></canvas>
          </div>
          <div class="avatar-modal-toolbar">
            <label for="avatarZoom">缩放</label>
            <input id="avatarZoom" type="range" min="0.5" max="3" step="0.01" value="1" />
            <div class="spacer"></div>
            <button id="avatarCancel" class="btn btn-secondary">取消</button>
            <button id="avatarSave" class="btn btn-primary">保存</button>
          </div>
        </div>
        <div class="avatar-hint">拖拽调整位置，滚轮或滑块缩放大小</div>
      </div>
    </div>

    <!-- 筛选浮窗 -->
    <div id="filterModal" class="filter-modal hidden">
      <div class="filter-content">
        <div class="filter-header">
          <h3>筛选条件</h3>
          <button class="filter-close" id="filterClose">&times;</button>
        </div>
        <div class="filter-body">
          <div class="filter-group">
            <div class="filter-group-title">版本</div>
            <div class="filter-chips" id="filterVersion"></div>
          </div>
          <div class="filter-group">
            <div class="filter-group-title">种类</div>
            <div class="filter-chips" id="filterRarity"></div>
          </div>
          <div class="filter-group">
            <div class="filter-group-title">条件</div>
            <div class="filter-chips" id="filterCondition"></div>
          </div>
          <div class="filter-group">
            <div class="filter-group-title">完成状态</div>
            <div class="filter-chips" id="filterStatus"></div>
          </div>
          <div class="filter-group">
            <div class="filter-group-title">收藏品</div>
            <div class="filter-chips" id="filterCollect"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mobile-container">
      <!-- 个人信息面板 -->
      <div class="user-profile-panel" id="userProfile">
        <div class="user-card-header" id="userProfileHeader">艾欧泽亚捕鱼证</div>
        <div class="user-divider"></div>
        
        <!-- 移动端圆形头像 -->
        <div class="avatar-mobile-box">
          <div class="avatar-mobile-wrap" id="avatarMobileWrap">
            <img class="avatar mobile" id="userAvatarMobile" src="./assets/icons/others/profile.webp" alt="头像" onerror="this.style.display='none'" />
            <input type="file" id="avatarFileMobile" accept="image/*" hidden />
          </div>
        </div>
        
        <div class="user-card-meta">
          <div class="meta-row">
            <div class="meta-label">持证人</div>
            <div class="meta-value" id="userNickname" contenteditable="true" data-placeholder="点击输入昵称">渔夫</div>
          </div>
          <div class="meta-row">
            <div class="meta-label">服务器</div>
            <div class="meta-value" id="userWorld" contenteditable="true" data-placeholder="服务器名">未设置</div>
          </div>
          <div class="meta-row">
            <div class="meta-label">捕鱼进度</div>
            <div class="meta-value" id="userProgress">鱼王 0/0 普通鱼 0/0</div>
          </div>
          <div class="meta-row">
            <div class="meta-label">证件编号</div>
            <div class="meta-value" id="userCertId" contenteditable="true" data-placeholder="证件编号">FF14-001</div>
          </div>
          <div class="meta-row">
            <div class="meta-label">发证日期</div>
            <div class="meta-value" id="userIssueDate" contenteditable="true" data-placeholder="发证日期">2024-01-01</div>
          </div>
        </div>
        
        <div class="cert-achievements">
          <div class="cert-achievements-title">战利品</div>
          <div class="cert-loot-grid" id="lootGrid">
            <!-- 14个战利品槽位 (7x2) -->
            <div class="cert-loot-item" data-index="0"></div>
            <div class="cert-loot-item" data-index="1"></div>
            <div class="cert-loot-item" data-index="2"></div>
            <div class="cert-loot-item" data-index="3"></div>
            <div class="cert-loot-item" data-index="4"></div>
            <div class="cert-loot-item" data-index="5"></div>
            <div class="cert-loot-item" data-index="6"></div>
            <div class="cert-loot-item" data-index="7"></div>
            <div class="cert-loot-item" data-index="8"></div>
            <div class="cert-loot-item" data-index="9"></div>
            <div class="cert-loot-item" data-index="10"></div>
            <div class="cert-loot-item" data-index="11"></div>
            <div class="cert-loot-item" data-index="12"></div>
            <div class="cert-loot-item" data-index="13"></div>
          </div>
        </div>
        
        <div class="cert-footer-note">本证件仅限艾欧泽亚大陆使用</div>
      </div>

      <!-- 钓鱼列表面板 -->
      <div class="fish-list-panel">
        <div class="fish-list-header">
          <div class="search-bar">
            <input type="text" id="searchInput" placeholder="搜索鱼类..." />
            <button class="filter-btn" id="filterBtn" title="筛选">
              <img src="./assets/icons/button/filter.webp" alt="筛选" onerror="this.style.display='none'" />
            </button>
          </div>
        </div>
        <div class="fish-list" id="fishList">
          <!-- 鱼类列表将通过JavaScript动态加载 -->
        </div>
      </div>
    </div>

    <!-- 移动端鱼类详情浮窗 -->
    <div id="detailModal" class="detail-modal hidden">
      <div class="detail-modal-panel">
        <div class="detail-modal-header">
          <span>鱼类详情</span>
          <button class="detail-modal-close" id="detailModalClose">&times;</button>
        </div>
        <div class="detail-modal-body" id="detailModalBody">
          <!-- 详情内容将通过JavaScript注入 -->
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-content">
      <p>&copy; 2024 McFisher. 为艾欧泽亚的钓鱼人而生。</p>
    </div>
  </footer>

  <script src="./device-detector.js"></script>
  <script src="./mobile.js"></script>
  <script>
    // 注册 Service Worker 并处理更新
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
            
            // 监听更新
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // 新版本已安装，提示用户刷新
                    console.log('New content is available; please refresh.');
                    // 自动跳过等待
                    newWorker.postMessage({ action: 'skipWaiting' });
                  }
                });
              }
            });
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
          
        // 监听 Service Worker 控制器变化
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          // 新 Service Worker 已接管，刷新页面
          window.location.reload();
        });
      });
    }
  </script>
</body>
</html>
